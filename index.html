<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOCAL-HEALTH - Respiratory Risk Assessment</title>
    <meta name="description" content="Get an early lung and heart risk assessment from your voice in under 60 seconds.">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <main class="container">

        <!-- Section 1: Landing Page -->
        <div id="landing-section" class="card view-section active">
            <img src="logo.png" alt="Company Logo" class="company-logo">
            <h1 class="logo">VOCAL-HEALTH</h1>
            <p class="description">
                Get an early lung and heart risk assessment from your voice in under 60 seconds.
            </p>
            <div class="info-box">
                <ul class="feature-list">
                    <li>Based on validated respiratory sound datasets</li>
                    <li>Non-invasive - No data stored without consent</li>
                </ul>
            </div>
            <button class="cta-button" onclick="transitionTo('questionnaire-section')">
                Start Assessment <span class="arrow">&rarr;</span>
            </button>
        </div>

        <!-- Section 2: Questionnaire -->
        <div id="questionnaire-section" class="card view-section">
            <img src="logo.png" alt="Company Logo" class="company-logo">
            <h2 class="section-title">Risk Assessment</h2>
            <form id="health-form">
                <div class="form-group">
                    <label>Age</label>
                    <input type="number" id="age" name="age" min="1" max="120" placeholder="Enter your age">
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <div class="radio-group">
                        <label><input type="radio" name="gender" value="male"> Male</label>
                        <label><input type="radio" name="gender" value="female"> Female</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Smoking History</label>
                    <div class="radio-stack">
                        <label><input type="radio" name="smoking" value="never"> Never Smoked</label>
                        <label><input type="radio" name="smoking" value="former"> Former Smoker</label>
                        <label><input type="radio" name="smoking" value="current"> Active Smoker (Current)</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Environment</label>
                    <p class="subtitle">Are you currently in a noisy environment?</p>
                    <div class="radio-group">
                        <label><input type="radio" name="noisy" value="yes"> Yes</label>
                        <label><input type="radio" name="noisy" value="no"> No</label>
                    </div>
                </div>

                <h3 class="subsection-title">Respiratory Symptoms</h3>
                <div class="form-group">
                    <label>Cough Duration</label>
                    <div class="radio-stack">
                        <label><input type="radio" name="cough" value="none"> No cough</label>
                        <label><input type="radio" name="cough" value="acute"> Less than 2 weeks</label>
                        <label><input type="radio" name="cough" value="chronic"> More than 2 weeks (Chronic)</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Shortness of Breath (Dyspnea)</label>
                    <p class="subtitle">During light activity?</p>
                    <div class="radio-group">
                        <label><input type="radio" name="dyspnea" value="yes"> Yes</label>
                        <label><input type="radio" name="dyspnea" value="no"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>History of Asthma or COPD?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="asthma_copd" value="yes"> Yes</label>
                        <label><input type="radio" name="asthma_copd" value="no"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Chest Tightness or Wheezing?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="wheezing" value="yes"> Yes</label>
                        <label><input type="radio" name="wheezing" value="no"> No</label>
                    </div>
                </div>

                <h3 class="subsection-title">Cardiac &amp; Circulatory</h3>
                <div class="form-group">
                    <label>History of Hypertension?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hypertension" value="yes"> Yes</label>
                        <label><input type="radio" name="hypertension" value="no"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Night Dyspnea?</label>
                    <p class="subtitle">Waking up gasping for air?</p>
                    <div class="radio-group">
                        <label><input type="radio" name="night_dyspnea" value="yes"> Yes</label>
                        <label><input type="radio" name="night_dyspnea" value="no"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Unusual Swelling (Ankles/Feet)?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="swelling" value="yes"> Yes</label>
                        <label><input type="radio" name="swelling" value="no"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Excessive Fatigue / Voice Tiredness?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="fatigue" value="yes"> Yes</label>
                        <label><input type="radio" name="fatigue" value="no"> No</label>
                    </div>
                </div>

                <button type="button" class="cta-button" onclick="submitForm()">
                    Next: Audio Recording <span class="arrow">&rarr;</span>
                </button>
            </form>
        </div>

        <!-- Section 3: Audio Recording -->
        <div id="recording-section" class="card view-section">
            <img src="logo.png" alt="Company Logo" class="company-logo">
            <h2 class="section-title">Voice Recording</h2>
            <p class="description">Please breathe deeply and then sustain a vowel sound "Ahhh" for up to 10 seconds.</p>

            <!-- Hidden until recording starts -->
            <div id="visualizerWrapper" class="visualizer-wrapper vis-hidden">
                <div class="visualizer-container">
                    <canvas id="audioVisualizer" width="400" height="150"></canvas>
                </div>
                <div class="timer-bar">
                    <div class="timer-fill" id="timerFill"></div>
                </div>
                <p id="timerText" class="timer-text">0s / 10s</p>
            </div>

            <div class="recording-controls">
                <button id="recordBtn" class="cta-button" onclick="toggleRecording()">
                    Start Recording
                </button>
                <p id="recordingStatus" class="status-text">Press the button to begin</p>
            </div>
        </div>

        <!-- Section 4: Result (Dashboard Style) -->
        <div id="result-section" class="view-section">
            <h2 class="result-header-text">Your Screening Result</h2>

            <div class="card">
                <img src="logo.png" alt="Company Logo" class="company-logo">
                <h2 id="resultTitle" class="result-status">Low Risk</h2>

                <!-- SVG Gauge -->
                <div class="gauge-wrapper">
                    <svg class="gauge-svg" viewBox="0 0 200 110">
                        <!-- Background arc -->
                        <path d="M 15 100 A 85 85 0 0 1 185 100" stroke="#e2e8f0" stroke-width="14" fill="none"
                            stroke-linecap="round" />
                        <!-- Filled arc -->
                        <path id="gaugeArc" d="M 15 100 A 85 85 0 0 1 185 100" stroke="#10b981" stroke-width="14"
                            fill="none" stroke-linecap="round" stroke-dasharray="267" stroke-dashoffset="267"
                            style="transition: stroke-dashoffset 1.2s ease-out, stroke 0.5s ease;" />
                        <!-- Score text -->
                        <text x="100" y="88" text-anchor="middle" font-family="Inter, sans-serif" font-weight="800"
                            fill="#334155">
                            <tspan id="svgScoreNum" font-size="40">3</tspan>
                            <tspan font-size="20" fill="#94a3b8">/10</tspan>
                        </text>
                    </svg>
                </div>

                <p id="resultSummary" class="result-summary">
                    Voice patterns align with healthy respiratory function.
                </p>

                <!-- Dashboard Cards -->
                <div class="dashboard-grid">
                    <div class="stat-card cardiac">
                        <span class="stat-icon">‚ù§Ô∏è</span>
                        <span class="stat-title">CARDIAC</span>
                        <span class="stat-desc" id="cardiacDesc">No cardiac risks detected. Heart rhythm indicators are
                            stable.</span>
                    </div>
                    <div class="stat-card pulmonary">
                        <span class="stat-icon">ü´Å</span>
                        <span class="stat-title">PULMONARY</span>
                        <span class="stat-desc" id="pulmonaryDesc">No pulmonary risks detected. Airflow duration is
                            healthy.</span>
                    </div>
                </div>

                <!-- Why This Result -->
                <div class="details-section">
                    <h4 class="details-title-sm">‚ìò Why This Result?</h4>
                    <ul class="details-list" id="reasonList">
                        <li>Stable breath sustain detected</li>
                        <li>Clear resonance and pitch stability</li>
                        <li>No obstructive patterns identified</li>
                    </ul>
                </div>

                <!-- Next Steps -->
                <div class="recommendation-box">
                    <h4 class="rec-title">What Should I Do Next?</h4>
                    <ul class="details-list" id="actionList">
                        <li>Maintain vocal hygiene and hydration</li>
                        <li>No immediate medical action required based on this screening</li>
                    </ul>
                </div>

                <p class="footer-note">
                    Note: This risk estimate is not a medical diagnosis. Consult a healthcare professional for further
                    evaluation.
                </p>

                <div class="action-buttons">
                    <button class="cta-button primary-blue" onclick="alert('Full report feature coming soon.')">
                        View Detailed Report
                    </button>
                    <button class="cta-button secondary" onclick="restartAssessment()">
                        Restart ‚Üª
                    </button>
                </div>
            </div>
        </div>

    </main>

    <footer class="footer">
        <p>Made by the VOCAL-HEALTH Team for Indonesia</p>
    </footer>

    <script>
        // ========== Constants ==========
        const MAX_RECORD_SECONDS = 10;

        // ========== State ==========
        const state = {
            formData: {},
            audioBlob: null,
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            riskScore: 0,
            recordingStartTime: 0
        };

        // ========== Smooth View Transitions ==========
        function transitionTo(nextSectionId) {
            const current = document.querySelector('.view-section.active');
            const next = document.getElementById(nextSectionId);

            if (current) {
                current.style.opacity = '0';
                current.style.transform = 'translateY(-15px)';

                setTimeout(() => {
                    current.classList.remove('active');
                    current.style.opacity = '';
                    current.style.transform = '';

                    if (next) {
                        next.classList.add('active');
                        next.style.opacity = '0';
                        next.style.transform = 'translateY(15px)';
                        next.offsetHeight; // force reflow
                        next.style.opacity = '1';
                        next.style.transform = 'translateY(0)';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 350);
            } else {
                if (next) next.classList.add('active');
            }
        }

        // ========== Form ==========
        function submitForm() {
            const form = document.getElementById('health-form');
            const data = new FormData(form);
            const formObj = Object.fromEntries(data.entries());

            if (!formObj.age || !formObj.gender) {
                alert('Please fill in at least Age and Gender.');
                return;
            }

            state.formData = formObj;
            transitionTo('recording-section');
            setupAudio();
        }

        // ========== Audio ==========
        let audioContext, analyser, dataArray;
        let canvas, canvasCtx;
        let animationId;
        let waveformBuffer = []; // stores {x, amplitude} entries

        async function setupAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                analyser.fftSize = 2048;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                canvas = document.getElementById('audioVisualizer');
                canvasCtx = canvas.getContext('2d');

                state.mediaRecorder = new MediaRecorder(stream);
                state.mediaRecorder.ondataavailable = (e) => state.audioChunks.push(e.data);
                state.mediaRecorder.onstop = processAudio;

                // Draw initial empty state
                clearCanvas();
            } catch (err) {
                console.error('Error accessing microphone:', err);
                alert('Microphone access is required for this step.');
            }
        }

        function clearCanvas() {
            if (!canvasCtx) return;
            canvasCtx.fillStyle = '#f3f4f6';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            // Center line
            canvasCtx.beginPath();
            canvasCtx.strokeStyle = '#e5e7eb';
            canvasCtx.moveTo(0, canvas.height / 2);
            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }

        function drawWaveform() {
            animationId = requestAnimationFrame(drawWaveform);

            if (!state.isRecording) return;

            const elapsed = (Date.now() - state.recordingStartTime) / 1000;

            // Auto-stop at max time
            if (elapsed >= MAX_RECORD_SECONDS) {
                stopRecording();
                return;
            }

            // Update timer
            document.getElementById('timerText').textContent =
                Math.floor(elapsed) + 's / ' + MAX_RECORD_SECONDS + 's';
            document.getElementById('timerFill').style.width =
                (elapsed / MAX_RECORD_SECONDS * 100) + '%';

            // Calculate RMS amplitude
            analyser.getByteTimeDomainData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const v = (dataArray[i] - 128) / 128.0;
                sum += v * v;
            }
            const rms = Math.sqrt(sum / dataArray.length);

            let height = rms * canvas.height * 3;
            if (height > canvas.height / 2) height = canvas.height / 2;

            // Position based on time (left to right over 10 seconds)
            const x = (elapsed / MAX_RECORD_SECONDS) * canvas.width;
            waveformBuffer.push({ x, h: height });

            // Redraw entire waveform
            clearCanvas();
            canvasCtx.fillStyle = '#3B82F6';
            const barWidth = 2;

            for (const bar of waveformBuffer) {
                if (bar.h > 0.5) {
                    const bx = bar.x;
                    const by = (canvas.height / 2) - bar.h;
                    const bh = bar.h * 2;
                    canvasCtx.fillRect(bx, by, barWidth, bh);
                }
            }
        }

        function toggleRecording() {
            if (!state.isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('recordingStatus');
            const wrapper = document.getElementById('visualizerWrapper');

            // Show visualizer with animation
            wrapper.classList.remove('vis-hidden');
            wrapper.classList.add('vis-visible');

            // Reset
            state.audioChunks = [];
            waveformBuffer = [];
            clearCanvas();
            document.getElementById('timerFill').style.width = '0%';
            document.getElementById('timerText').textContent = '0s / ' + MAX_RECORD_SECONDS + 's';

            // Start
            state.mediaRecorder.start();
            state.isRecording = true;
            state.recordingStartTime = Date.now();

            btn.textContent = "Stop Recording";
            btn.classList.add('recording');
            status.textContent = "Recording... (Speak now)";

            drawWaveform();
        }

        function stopRecording() {
            if (!state.isRecording) return;

            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('recordingStatus');

            state.mediaRecorder.stop();
            state.isRecording = false;

            btn.textContent = "Processing...";
            btn.disabled = true;
            btn.classList.remove('recording');
            status.textContent = "Processing audio...";

            cancelAnimationFrame(animationId);

            // Final timer update
            const elapsed = Math.min(
                (Date.now() - state.recordingStartTime) / 1000,
                MAX_RECORD_SECONDS
            );
            document.getElementById('timerText').textContent =
                Math.floor(elapsed) + 's / ' + MAX_RECORD_SECONDS + 's';
            document.getElementById('timerFill').style.width =
                (elapsed / MAX_RECORD_SECONDS * 100) + '%';
        }

        function processAudio() {
            state.audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });

            setTimeout(() => {
                calculateRisk();
                transitionTo('result-section');
            }, 1000);
        }

        // ========== Risk Calculation ==========
        function calculateRisk() {
            let score = 0;
            const f = state.formData;

            if (f.smoking === 'current') score += 2;
            if (f.smoking === 'former') score += 1;
            if (f.cough === 'chronic') score += 2;
            if (f.dyspnea === 'yes') score += 2;
            if (f.asthma_copd === 'yes') score += 2;
            if (f.wheezing === 'yes') score += 1;
            if (f.night_dyspnea === 'yes') score += 2;

            const audioScore = Math.floor(Math.random() * 2) + 1; // 1 or 2

            let totalRisk = score + audioScore;
            if (totalRisk > 10) totalRisk = 10;
            if (totalRisk < 1) totalRisk = 1;

            state.riskScore = totalRisk;

            // --- Populate UI ---
            document.getElementById('svgScoreNum').textContent = totalRisk;

            // SVG gauge: arc length ‚âà 267. dashoffset = 267 - (score/10 * 267)
            const arcLength = 267;
            const offset = arcLength - (totalRisk / 10) * arcLength;

            let color = '#10b981';
            let status = 'Low Risk';
            if (totalRisk > 3) { color = '#f59e0b'; status = 'Moderate Risk'; }
            if (totalRisk > 7) { color = '#ef4444'; status = 'High Risk'; }

            const gaugeArc = document.getElementById('gaugeArc');
            // Reset first for animation
            gaugeArc.style.strokeDashoffset = arcLength;
            gaugeArc.style.stroke = color;

            // Animate after a tiny delay
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    gaugeArc.style.strokeDashoffset = offset;
                });
            });

            document.getElementById('resultTitle').textContent = status;
            document.getElementById('resultTitle').style.color = color;

            const summaryEl = document.getElementById('resultSummary');
            const cardiacDesc = document.getElementById('cardiacDesc');
            const pulmDesc = document.getElementById('pulmonaryDesc');
            const reasonList = document.getElementById('reasonList');
            const actionList = document.getElementById('actionList');

            if (totalRisk <= 3) {
                summaryEl.textContent = "Voice patterns align with healthy respiratory function.";
                cardiacDesc.textContent = "No cardiac risks detected. Heart rhythm indicators are stable.";
                pulmDesc.textContent = "No pulmonary risks detected. Airflow duration is healthy.";
                reasonList.innerHTML = `
                    <li>Stable breath sustain detected</li>
                    <li>Clear resonance and pitch stability</li>
                    <li>No obstructive patterns identified</li>`;
                actionList.innerHTML = `
                    <li>Maintain vocal hygiene and hydration</li>
                    <li>No immediate medical action required based on this screening</li>`;
            } else if (totalRisk <= 7) {
                summaryEl.textContent = "Some indicators suggest potential respiratory or cardiac strain.";
                cardiacDesc.textContent = f.hypertension === 'yes'
                    ? "History of hypertension noted. Monitor blood pressure."
                    : "Monitor heart rate stability.";
                pulmDesc.textContent = f.cough === 'chronic'
                    ? "Chronic cough indicators present. Airflow may be restricted."
                    : "Minor airflow irregularities detected.";
                reasonList.innerHTML = `
                    <li>Reduced breath sustain duration</li>
                    <li>Possible strain markers in voice frequency</li>
                    <li>Risk factors from questionnaire weighted into score</li>`;
                actionList.innerHTML = `
                    <li>Consult a general practitioner for a routine checkup</li>
                    <li>Monitor symptoms for any changes over the next weeks</li>`;
            } else {
                summaryEl.textContent = "Multiple risk indicators detected. Please seek professional evaluation.";
                cardiacDesc.textContent = "Elevated cardiac risk indicators. Professional evaluation recommended.";
                pulmDesc.textContent = "Significant pulmonary risk markers detected in voice analysis.";
                reasonList.innerHTML = `
                    <li>Significant breath pattern irregularities</li>
                    <li>Multiple risk factors from questionnaire</li>
                    <li>Voice analysis suggests possible airway obstruction</li>`;
                actionList.innerHTML = `
                    <li>Seek medical attention promptly</li>
                    <li>Bring this screening summary to your healthcare provider</li>`;
            }
        }

        // ========== Restart ==========
        function restartAssessment() {
            state.formData = {};
            state.audioBlob = null;
            state.audioChunks = [];
            state.riskScore = 0;
            waveformBuffer = [];

            document.getElementById('health-form').reset();
            const btn = document.getElementById('recordBtn');
            btn.textContent = "Start Recording";
            btn.style.backgroundColor = "";
            btn.disabled = false;
            btn.classList.remove('recording');

            // Hide visualizer again
            const wrapper = document.getElementById('visualizerWrapper');
            wrapper.classList.remove('vis-visible');
            wrapper.classList.add('vis-hidden');

            // Reset gauge
            document.getElementById('gaugeArc').style.strokeDashoffset = 267;

            transitionTo('landing-section');
        }
    </script>
</body>

</html>
